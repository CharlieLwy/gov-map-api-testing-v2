<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>送貨地址 – 含 HKTM + WGS84 + 超準導航</title>
<style>
  body { font-family: system-ui, sans-serif; max-width: 620px; margin: 40px auto; padding: 20px; background:#f8f8f8; line-height:1.8; }
  input, select { width:100%; padding:14px; margin:8px 0; font-size:17px; border:1px solid #bbb; border-radius:10px; }
  button { background:#ff6600; color:white; padding:18px; font-size:19px; border:none; border-radius:12px; width:100%; cursor:pointer; margin-top:25px; }
  .addr-wrapper { position:relative; }
  .list { position:absolute; top:100%; left:0; right:0; background:white; max-height:320px; overflow-y:auto; z-index:9999; border-radius:10px; box-shadow:0 8px 25px rgba(0,0,0,0.2); }
  .list div { padding:15px; border-bottom:1px solid #eee; cursor:pointer; }
  .list div:hover { background:#fff8f0; }
  .result { background:white; padding:20px; border-radius:12px; margin-top:20px; box-shadow:0 4px 20px rgba(0,0,0,0.1); line-height:2; }
  .nav { display:block; background:#00ca9e; color:white; text-align:center; padding:18px; border-radius:12px; text-decoration:none; font-size:19px; margin-top:20px; font-weight:bold; }
</style>
</head>
<body>

<h2>送貨地址（含 HKTM + WGS84）</h2>

<label>分區（18區）← 自動填入</label>
<select id="district">
  <option value="">請選擇地址後自動顯示</option>
  <option>中西區</option><option>東區</option><option>南區</option><option>灣仔區</option>
  <option>九龍城區</option><option>觀塘區</option><option>葵青區</option><option>深水埗區</option>
  <option>黃大仙區</option><option>油尖旺區</option><option>離島區</option><option>荃灣區</option>
  <option>屯門區</option><option>元朗區</option><option>北區</option><option>大埔區</option>
  <option>沙田區</option><option>西貢區</option>
</select>

<div class="addr-wrapper">
  <label>屋苑／大廈／街道名稱</label>
  <input type="text" id="addr" placeholder="例如：麗港城、紅磡站" autocomplete="off">
  <div id="list" class="list"></div>
</div>

<label>座數／樓層／單位／室</label>
<input type="text" id="floor" placeholder="例如：15樓 A室、901">

<button onclick="generate()">產生地址＋導航</button>

<div id="result"></div>

<script>
const districtMap = {CW:"中西區",EA:"東區",SO:"南區",WC:"灣仔區",KC:"九龍城區",KT:"觀塘區",KW:"葵青區",SSP:"深水埗區",WTS:"黃大仙區",YT:"油尖旺區",IS:"離島區",TW:"荃灣區",TM:"屯門區",YL:"元朗區",N:"北區",TP:"大埔區",ST:"沙田區",SK:"西貢區"};

// 官方級精準 HK1980 Grid → WGS84 轉換（誤差 < 2米）
async function hk80ToWgs84(e, n) {
  const url = `https://www.geodetic.gov.hk/transform/v2/?inSys=hkgrid&e=${e}&n=${n}`;
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Geodetic API returned ' + response.status);
    const data = await response.json();
    return {lat: parseFloat(data.wgsLat).toFixed(7), lng: parseFloat(data.wgsLong).toFixed(7)};
  } catch (err) {
    console.error('hk80ToWgs84 error:', err);
    throw err;
  }
}

let chosen = null;

document.getElementById("addr").addEventListener("input", function(){
  let v = this.value.trim();
  document.getElementById("list").innerHTML = "";
  if(v.length < 2) return;

  fetch("https://www.map.gov.hk/gs/api/v1.0.0/locationSearch?q="+encodeURIComponent(v))
    .then(r=>r.json())
    .then(data=>{
      const results = data.slice(0,12);
      // If the user typed a suggestion plus extra suffix (e.g. '華樂豪庭10座'),
      // don't show the dropdown — they likely want to keep the suffix.
      for (const item of results) {
        const displayName = item.nameZH || item.nameEN || item.addressZH || item.addressEN || "未知地址";
        if (v.startsWith(displayName) && v.length > displayName.length) {
          document.getElementById("list").innerHTML = "";
          return;
        }
      }

      results.forEach(item=>{
        let displayName = item.nameZH || item.nameEN || item.addressZH || item.addressEN || "未知地址";
        let street = (item.nameZH || item.nameEN) ? (item.addressZH || item.addressEN || "") : "";
        let dist   = item.districtZH || districtMap[item.district] || "未知區";

        let div = document.createElement("div");
        div.innerHTML = `<strong>${displayName}</strong><br><small>${street}（${dist}）</small>`;
        div.onclick = ()=>{
          const addrInput = document.getElementById("addr");
          const prev = addrInput.value || "";
          let suffix = "";
          if (prev.startsWith(displayName)) {
            suffix = prev.slice(displayName.length).trim();
          } else if (prev.includes(displayName)) {
            const idx = prev.indexOf(displayName) + displayName.length;
            suffix = prev.slice(idx).trim();
          }
          addrInput.value = displayName + (suffix ? suffix : "");
          document.getElementById("district").value = dist;
          chosen = {name: displayName, street: street, suffix: suffix, dist: dist, x: item.x, y: item.y};
          document.getElementById("list").innerHTML = "";
        };
        document.getElementById("list").appendChild(div);
      });
    });
});

async function generate(){
  // If user didn't explicitly pick a suggestion, try to resolve the typed address.
  if(!chosen){
    const addrVal = document.getElementById("addr").value.trim();
    if(!addrVal){ alert("請從下拉選單選擇一個地址或輸入地址！"); return; }
    try {
      const resp = await fetch("https://www.map.gov.hk/gs/api/v1.0.0/locationSearch?q="+encodeURIComponent(addrVal));
      const data = await resp.json();
      if(!data || data.length === 0){
        alert("找不到相符的地址，請嘗試更改關鍵字或選擇建議項目。");
        return;
      }
      // Use the best match (first result) but preserve any manual suffix typed by user
      const item = data[0];
      let displayName = item.nameZH || item.nameEN || item.addressZH || item.addressEN || "未知地址";
      let street = (item.nameZH || item.nameEN) ? (item.addressZH || item.addressEN || "") : "";
      let dist   = item.districtZH || districtMap[item.district] || "未知區";
      // compute suffix the same way as selection handler
      let suffix = "";
      if (addrVal.startsWith(displayName)) {
        suffix = addrVal.slice(displayName.length).trim();
      } else if (addrVal.includes(displayName)) {
        const idx = addrVal.indexOf(displayName) + displayName.length;
        suffix = addrVal.slice(idx).trim();
      }
      chosen = {name: displayName, street: street, suffix: suffix, dist: dist, x: item.x, y: item.y};
      // also update the district input so UI reflects it
      document.getElementById("district").value = dist;
    } catch (err) {
      console.error('locationSearch error:', err);
      alert('查詢地址時發生錯誤，請稍後再試。');
      return;
    }
  }

  let floor = document.getElementById("floor").value.trim();
  let suffixPart = "";
  if (chosen.suffix) {
    suffixPart = (chosen.suffix.startsWith("，") || chosen.suffix.startsWith(",")) ? chosen.suffix : "，" + chosen.suffix;
  }
  let displayAddr = chosen.name + suffixPart + (chosen.street ? "，" + chosen.street : "") + (floor ? "，" + floor : "");

  let wgs;
  try {
    wgs = await hk80ToWgs84(chosen.x, chosen.y);
  } catch (err) {
    document.getElementById("result").innerHTML = `<div class="result"><strong>無法取得經緯度：</strong> ${err.message || err}</div>`;
    return;
  }

  let googleQuery = chosen.name + (chosen.suffix ? " " + chosen.suffix : "") + (chosen.street ? " " + chosen.street : "");
  let googleLink = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(googleQuery);

  document.getElementById("result").innerHTML = `
    <strong>完整送貨地址</strong><br>${displayAddr}<br><br>
    <strong>18區：</strong> ${chosen.dist}<br>
    <strong>HKTM 格網坐標</strong><br>X: ${chosen.x}　Y: ${chosen.y}<br><br>
    <strong>WGS84 經緯度</strong><br>緯度: ${wgs.lat}　經度: ${wgs.lng}<br><br>
    <a href="${googleLink}" target="_blank" class="nav">
      Google Map 用地址搵
    </a>
    <a href="https://www.google.com/maps/search/?api=1&query=${wgs.lat},${wgs.lng}" target="_blank" class="nav">
      Google Map 用經緯度搵
    </a>
  `;
}
</script>

</body>
</html>
